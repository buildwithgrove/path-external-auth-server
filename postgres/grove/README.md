<div align="center">
<h1>PEAS<br/>Grove Portal Database Compatibility</h1>
<img src="https://storage.googleapis.com/grove-brand-assets/Presskit/Logo%20Joined-2.png" alt="Grove logo" width="500"/>

</div>
<br/>

# Table of Contents <!-- omit in toc -->

- [Grove Postgres Database Schema](#grove-postgres-database-schema)
    - [Entity Relationship Diagram](#entity-relationship-diagram)
- [SQLC Autogeneration](#sqlc-autogeneration)

<br/>

# Grove Postgres Database Schema

<div align="center">
<a href="https://www.postgresql.org/">
<img src="https://static-00.iconduck.com/assets.00/postgresql-icon-1987x2048-v2fkmdaw.png" alt="PostgreSQL logo" width="150"/>
<div>https://www.postgresql.org/</div>
</a>
</div>
<br/>

The [Grove Postgres Driver schema file](https://github.com/buildwithgrove/path-auth-data-server/blob/main/postgres/grove/sqlc/grove_schema.sql)
uses a subset of tables from the existing Grove Portal database schema, allowing `PATH` to source its authorization data from the existing Grove Portal database.

It converts the data stored in the `portal_applications` table and its associated tables into the `PortalApp` format expected by `PEAS`.

It also listens for updates to the Grove Portal DB and streams updates to `PEAS` in real time as changes are made to the connected Postgres database.

### Entity Relationship Diagram

This ERD shows the subset of tables from the full Grove Portal DB schema that are used by the Grove Postgres Driver in PEAS.

```mermaid
erDiagram
    ACCOUNTS {
        VARCHAR(10) id PK
        VARCHAR(25) plan_type FK
    }

    PORTAL_APPLICATIONS {
        VARCHAR(24) id PK
        VARCHAR(10) account_id FK
        BOOLEAN deleted
        TIMESTAMP deleted_at
    }

    PORTAL_APPLICATION_SETTINGS {
        SERIAL id PK
        VARCHAR(24) application_id FK
        VARCHAR(64) secret_key
        BOOLEAN secret_key_required
    }

    PORTAL_APPLICATION_CHANGES {
        SERIAL id PK
        VARCHAR(24) portal_app_id
        BOOLEAN is_delete
        TIMESTAMP changed_at
        TIMESTAMP processed_at
    }

    ACCOUNTS ||--o{ PORTAL_APPLICATIONS : "id"
    PORTAL_APPLICATIONS ||--o{ PORTAL_APPLICATION_SETTINGS : "id"
```

# SQLC Autogeneration

<div align="center">
<a href="https://docs.sqlc.dev/en/stable">
<img src="https://github.com/buildwithgrove/path-auth-data-server/blob/main/.github/img/sqlc.png?raw=true" alt="SQLC logo" width="150"/>
<div>https://docs.sqlc.dev/en/stable</div>
</a>
</div>
<br/>

The Postgres Driver uses `SQLC` to autogenerate the Postgres Go code needed to interact with the Postgres database/

The Make target `make gen_sqlc` will regenerate the Go code from the SQLC schema file.

This will output code autogenerated from the [postgres/grove/sqlc/grove_schema.sql](https://github.com/buildwithgrove/path-auth-data-server/blob/main/postgres/grove/sqlc/grove_schema.sql)
and [postgres/grove/sqlc/grove_queries.sql](https://github.com/buildwithgrove/path-auth-data-server/blob/main/postgres/grove/sqlc/grove_queries.sql) files
to the [postgres/grove/sqlc](https://github.com/buildwithgrove/path-auth-data-server/blob/main/postgres/grove/sqlc) directory.

`SQLC` configuration is defined in the [postgres/sqlc/sqlc.yaml](https://github.com/buildwithgrove/path-auth-data-server/blob/main/postgres/grove/sqlc/sqlc.yaml) file.
